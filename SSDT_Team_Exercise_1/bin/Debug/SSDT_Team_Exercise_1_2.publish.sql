/*
Deployment script for SSDT_Team_Exercise_1

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "SSDT_Team_Exercise_1"
:setvar DefaultFilePrefix "SSDT_Team_Exercise_1"
:setvar DefaultDataPath "C:\Users\anna.popova\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\Projects"
:setvar DefaultLogPath "C:\Users\anna.popova\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\Projects"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 8729bee1-8e97-4a0b-bc00-606c5af3c830 is skipped, element [Person].[Person].[Fname] (SqlSimpleColumn) will not be renamed to FName';


GO
PRINT N'Creating [Person].[Customer]...';


GO
CREATE TABLE [Person].[Customer] (
    [Id]            UNIQUEIDENTIFIER NOT NULL,
    [PersonId]      UNIQUEIDENTIFIER NOT NULL,
    [SalesPersonId] UNIQUEIDENTIFIER NOT NULL,
    [CreatedDate]   DATE             NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Person].[Person]...';


GO
CREATE TABLE [Person].[Person] (
    [Id]        UNIQUEIDENTIFIER NOT NULL,
    [IndexId]   BIGINT           IDENTITY (1, 1) NOT NULL,
    [FName]     NVARCHAR (50)    NOT NULL,
    [LName]     NVARCHAR (50)    NOT NULL,
    [BirthDate] DATE             NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Person].[Person].[IX_Person_IndexId]...';


GO
CREATE NONCLUSTERED INDEX [IX_Person_IndexId]
    ON [Person].[Person]([IndexId] ASC);


GO
PRINT N'Creating [Person].[SalesPerson]...';


GO
CREATE TABLE [Person].[SalesPerson] (
    [Id]        UNIQUEIDENTIFIER NOT NULL,
    [PersonId]  UNIQUEIDENTIFIER NOT NULL,
    [HiredDate] DATE             NOT NULL,
    [IsActive]  BIT              NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating on [Person].[Customer].[Id]...';


GO
ALTER TABLE [Person].[Customer]
    ADD DEFAULT NEWID() FOR [Id];


GO
PRINT N'Creating on [Person].[Customer].[CreatedDate]...';


GO
ALTER TABLE [Person].[Customer]
    ADD DEFAULT GETUTCDATE() FOR [CreatedDate];


GO
PRINT N'Creating on [Person].[Person].[Id]...';


GO
ALTER TABLE [Person].[Person]
    ADD DEFAULT NEWID() FOR [Id];


GO
PRINT N'Creating on [Person].[SalesPerson].[Id]...';


GO
ALTER TABLE [Person].[SalesPerson]
    ADD DEFAULT NEWID() FOR [Id];


GO
PRINT N'Creating on [Person].[SalesPerson].[HiredDate]...';


GO
ALTER TABLE [Person].[SalesPerson]
    ADD DEFAULT GETUTCDATE() FOR [HiredDate];


GO
PRINT N'Creating on [Person].[SalesPerson].[IsActive]...';


GO
ALTER TABLE [Person].[SalesPerson]
    ADD DEFAULT 1 FOR [IsActive];


GO
PRINT N'Creating [Person].[FK_Customer_ToPerson]...';


GO
ALTER TABLE [Person].[Customer] WITH NOCHECK
    ADD CONSTRAINT [FK_Customer_ToPerson] FOREIGN KEY ([PersonId]) REFERENCES [Person].[Person] ([Id]);


GO
PRINT N'Creating [Person].[FK_Customer_ToTable]...';


GO
ALTER TABLE [Person].[Customer] WITH NOCHECK
    ADD CONSTRAINT [FK_Customer_ToTable] FOREIGN KEY ([SalesPersonId]) REFERENCES [Person].[SalesPerson] ([Id]);


GO
PRINT N'Creating [Person].[FK_SalesPerson_ToTable]...';


GO
ALTER TABLE [Person].[SalesPerson] WITH NOCHECK
    ADD CONSTRAINT [FK_SalesPerson_ToTable] FOREIGN KEY ([PersonId]) REFERENCES [Person].[Person] ([Id]);


GO
PRINT N'Creating [Person].[CK_Person_Age]...';


GO
ALTER TABLE [Person].[Person] WITH NOCHECK
    ADD CONSTRAINT [CK_Person_Age] CHECK (DATEDIFF(YEAR,[BirthDate],GETDATE()) >= 18);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '8729bee1-8e97-4a0b-bc00-606c5af3c830')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('8729bee1-8e97-4a0b-bc00-606c5af3c830')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [Person].[Customer] WITH CHECK CHECK CONSTRAINT [FK_Customer_ToPerson];

ALTER TABLE [Person].[Customer] WITH CHECK CHECK CONSTRAINT [FK_Customer_ToTable];

ALTER TABLE [Person].[SalesPerson] WITH CHECK CHECK CONSTRAINT [FK_SalesPerson_ToTable];

ALTER TABLE [Person].[Person] WITH CHECK CHECK CONSTRAINT [CK_Person_Age];


GO
PRINT N'Update complete.';


GO
